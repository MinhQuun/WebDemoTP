## 1. Chá»‘t â€œbáº£ng gá»‘câ€ Ä‘á»ƒ bÃ¡m theo: `dbo.Tickets`

- Má»¥c tiÃªu cá»§a web â€œXem QR Ä‘Ã£ táº¡oâ€ lÃ  láº¥y danh sÃ¡ch QR theo mÃ£ ticket/QR.
- MÃ¬nh xÃ¡c Ä‘á»‹nh `dbo.Tickets` lÃ  báº£ng Ä‘Ãºng vÃ¬ nÃ³ cÃ³ cÃ¡c field trÃ¹ng vá»›i nghiá»‡p vá»¥ QR:
  + `ticketid, sodh (sá»‘ Ä‘Æ¡n), mahang (mÃ£ hÃ ng), ngaytao, ...` + cÃ¡c cá»™t tráº¡ng thÃ¡i cÃ´ng Ä‘oáº¡n (`ghinhandet`, `kiemtradet`, â€¦).
- Váº¥n Ä‘á»: **Tickets khÃ´ng cÃ³ `tenhang`** â‡’ muá»‘n hiá»ƒn thá»‹ â€œTÃªn hÃ ngâ€ trÃªn web thÃ¬ pháº£i **join qua báº£ng khÃ¡c** theo `mahang`.

---

## 2. QuÃ©t toÃ n DB Ä‘á»ƒ tÃ¬m báº£ng nÃ o â€œcÃ³ váº»â€ chá»©a TÃªn hÃ ng

**Logic**: tÃ¬m cÃ¡c báº£ng cÃ³ cá»™t kiá»ƒu:

* khÃ³a sáº£n pháº©m: `mahang` / `product` / `item`
* tÃªn sáº£n pháº©m: `tenhang` / `tensp` / `itemname` / `productname` / `name`

**CÃ¡ch lÃ m**: query metadata (`sys.tables`, `sys.columns`, `sys.schemas`) rá»“i gom danh sÃ¡ch cá»™t má»—i báº£ng (dÃ¹ng `STRING_AGG`).

ğŸ‘‰ Output bÆ°á»›c nÃ y cho báº¡n má»™t danh sÃ¡ch báº£ng + cÃ¡c cá»™t cá»§a nÃ³, Ä‘á»ƒ khoanh vÃ¹ng â€œá»©ng viÃªnâ€.

---

## 3. TÃ¬m â€œbáº£ng á»©ng viÃªn tháº­t sá»±â€ báº±ng cÃ¡ch test **má»™t mÃ£ hÃ ng cá»¥ thá»ƒ**

Báº¡n láº¥y má»™t `mahang` máº«u tá»« Tickets (vÃ­ dá»¥ `3215045`) rá»“i cháº¡y bÆ°á»›c â€œauto dÃ²â€:

**Logic**:

* Tá»« danh sÃ¡ch á»©ng viÃªn, cháº¡y dynamic SQL:

  * vá»›i má»—i báº£ng: `COUNT(*)` nhá»¯ng dÃ²ng cÃ³ `mahang = @v`
  * Ä‘á»“ng thá»i láº¥y thá»­ 1 `tenhang` máº«u (náº¿u cÃ³)
* LÆ°u káº¿t quáº£ vÃ o báº£ng táº¡m (#found) Ä‘á»ƒ xem báº£ng nÃ o match.

**Káº¿t quáº£**: tÃ¬m ra 2 báº£ng khá»›p vÃ  tráº£ Ä‘Æ°á»£c `tenhang`:

* `dbo.tbdongkien`
* `dbo.tblphieugiaohang`

=> Ã nghÄ©a: **TÃªn hÃ ng náº±m á»Ÿ cÃ¡c báº£ng nghiá»‡p vá»¥/cÃ´ng Ä‘oáº¡n**, khÃ´ng náº±m trong Tickets.

---

## 4. Kiá»ƒm tra rá»§i ro â€œjoin bá»‹ nhÃ¢n báº£nâ€ (1 mahang cÃ³ nhiá»u tenhang?)

Khi tháº¥y cÃ³ 2 báº£ng cÃ³ thá»ƒ map `mahang -> tenhang`, mÃ¬nh kiá»ƒm tra xem:

* má»—i báº£ng cÃ³ bá»‹ trÃ¹ng `mahang` khÃ´ng (1 mÃ£ hÃ ng xuáº¥t hiá»‡n nhiá»u dÃ²ng)
* náº¿u trÃ¹ng thÃ¬ join sáº½ lÃ m **Tickets bá»‹ ná»Ÿ dÃ²ng** (row multiplication)

**CÃ¡ch check**: `GROUP BY mahang HAVING COUNT(*) > 1` (láº¥y top cÃ¡c mÃ£ trÃ¹ng nhiá»u).

Káº¿t quáº£ báº¡n tháº¥y:

* cÃ³ cÃ¡c `mahang` xuáº¥t hiá»‡n ráº¥t nhiá»u láº§n trong tá»«ng báº£ng â‡’ cháº¯c cháº¯n khÃ´ng thá»ƒ join â€œtháº³ngâ€ mÃ  khÃ´ng xá»­ lÃ½.

---

## 5. Há»£p nháº¥t & â€œchuáº©n hÃ³aâ€ map `mahang -> tenhang` báº±ng VIEW

ÄÃ¢y lÃ  pháº§n quan trá»ng nháº¥t cá»§a toÃ n bá»™ xá»­ lÃ½ SQL:

**Má»¥c tiÃªu**: táº¡o má»™t nguá»“n duy nháº¥t, Ä‘áº£m báº£o:

* má»—i `mahang` chá»‰ ra **1 dÃ²ng tenhang**
* Æ°u tiÃªn báº£ng nÃ o Ä‘Ãºng nghiá»‡p vá»¥ (vd Æ°u tiÃªn báº£ng â€œÄ‘Ã³ng kiá»‡nâ€ hoáº·c â€œphiáº¿u giao hÃ ngâ€ tÃ¹y logic)
* náº¿u 1 mahang cÃ³ nhiá»u dÃ²ng thÃ¬ chá»n â€œdÃ²ng Ä‘áº¡i diá»‡nâ€ theo rule (thÆ°á»ng lÃ  dÃ²ng má»›i nháº¥t theo ngÃ y, hoáº·c theo má»©c Æ°u tiÃªn báº£ng)

ğŸ‘‰ NÃªn táº¡o view kiá»ƒu `vw_item_name` (tÃªn báº¡n Ä‘ang dÃ¹ng) vá»›i tÆ° duy:

* UNION nguá»“n tá»« 2 báº£ng:

  * nguá»“n A: `tbdongkien (mahang, tenhang, â€¦)`
  * nguá»“n B: `tblphieugiaohang (mahang, tenhang, â€¦)`
* DÃ¹ng `ROW_NUMBER() OVER (PARTITION BY mahang ORDER BY <priority>, <date desc>)`
  Ä‘á»ƒ láº¥y **rn = 1** â‡’ má»—i `mahang` chá»‰ cÃ²n 1 record.

=> `vw_item_name` trá»Ÿ thÃ nh â€œbáº£ng tá»« Ä‘iá»ƒnâ€ Ä‘á»ƒ join.

---

## 6. Join Tickets vá»›i `vw_item_name` Ä‘á»ƒ ra â€œTÃªn hÃ ngâ€ (khÃ´ng ná»Ÿ dÃ²ng)

Sau khi cÃ³ view map chuáº©n, mÃ¬nh join:

* `Tickets t`
* `vw_item_name n ON n.mahang = t.mahang`
* (vÃ  báº¡n cÃ²n join `Admins` Ä‘á»ƒ ra tÃªn ngÆ°á»i táº¡o, náº¿u cáº§n)

Rá»“i test báº±ng `SELECT TOP 50 ...` Ä‘á»ƒ tháº¥y:

* `ngaytao, ticketid, sodh, mahang, tenhang, dongia...` hiá»ƒn thá»‹ Ä‘Ãºng.

---

## 7. XÃ¡c nháº­n join â€œan toÃ nâ€ báº±ng so sÃ¡nh sá»‘ dÃ²ng

ÄÃ¢y lÃ  bÆ°á»›c xÃ¡c nháº­n ráº¥t quan trá»ng:

* `tickets_rows = COUNT(*) FROM dbo.Tickets`
* `joined_rows = COUNT(*) FROM dbo.Tickets t LEFT JOIN dbo.vw_item_name n ...`

Náº¿u `joined_rows == tickets_rows` â‡’ join **khÃ´ng lÃ m ná»Ÿ dá»¯ liá»‡u**, an toÃ n Ä‘á»ƒ Ä‘Æ°a lÃªn web.

Báº¡n Ä‘Ã£ cháº¡y vÃ  ra **báº±ng nhau** (398,160) â‡’ OK.

---

# TÃ³m gá»n 1 cÃ¢u

**Tickets lÃ  báº£ng gá»‘c cá»§a QR nhÆ°ng thiáº¿u tÃªn hÃ ng â†’ quÃ©t metadata Ä‘á»ƒ tÃ¬m báº£ng cÃ³ `tenhang` â†’ test 1 `mahang` Ä‘á»ƒ tÃ¬m Ä‘Ãºng báº£ng nguá»“n â†’ vÃ¬ dá»¯ liá»‡u trÃ¹ng nhiá»u dÃ²ng nÃªn táº¡o view chuáº©n hÃ³a `mahang -> tenhang` (ROW_NUMBER láº¥y 1 dÃ²ng) â†’ join Tickets vá»›i view â†’ kiá»ƒm tra rowcount Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng ná»Ÿ dÃ²ng.**

---

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ viáº¿t láº¡i thÃ nh **má»™t Ä‘oáº¡n â€œnote ká»¹ thuáº­tâ€ 10â€“15 dÃ²ng** Ä‘á»ƒ báº¡n copy dÃ¡n vÃ o README / bÃ¡o cÃ¡o cho anh hÆ°á»›ng dáº«n (giá»ng vÄƒn chuyÃªn nghiá»‡p, ngáº¯n gá»n).
